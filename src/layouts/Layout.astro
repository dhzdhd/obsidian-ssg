---
import "@/styles/globals.css";
import { ModeToggle } from "@/components/ModeToggle";
import { type TreeItem } from "@/lib/types";
import Tree from "@components/Tree.svelte";
import { CommandMenu } from "@components/Search";
import { ViewTransitions } from "astro:transitions";

interface Props {
  title: string;
}

const { title } = Astro.props;

const posts = await Astro.glob("../posts/**/*.md");

let result: TreeItem[] = [];
let level = { result };

posts.forEach((post, index) => {
  const rel_path = post.file.split("src/posts/")[1];
  const sanitized = rel_path.split(".md")[0];

  rel_path.split("/").reduce((r, name) => {
    if (!r[name]) {
      r[name] = { result: [] };
      if (name.endsWith(".md")) {
        r.result.push({
          title: name.replace(".md", ""),
          url: `/${sanitized}`,
          children: undefined,
          icon: "file",
        });
      } else {
        r.result.push({
          title: name,
          children: r[name].result,
          icon: "folder",
        });
      }
    }

    return r[name];
  }, level);
});
const data = result;
---

<script is:inline>
  function setDarkMode(document) {
    const getThemePreference = () => {
      if (
        typeof localStorage !== "undefined" &&
        localStorage.getItem("theme")
      ) {
        return localStorage.getItem("theme");
      }
      return window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "light";
    };
    const isDark = getThemePreference() === "dark";

    document.documentElement.classList[isDark ? "add" : "remove"]("dark");
  }

  setDarkMode(document);

  document.addEventListener("astro:before-swap", (event) => {
    setDarkMode(event.newDocument);
  });
</script>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Astro description" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link
      href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
      rel="stylesheet"
    />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <ViewTransitions />
  </head>
  <body class="flex flex-col">
    <header
      class="z-10 flex justify-between items-center px-5 bg-background h-14 w-dvw top-0 fixed border-b-[1px]"
    >
      <h1 class="text-2xl">Obsidian</h1>
      <div>
        <CommandMenu {data} client:load />
        <ModeToggle transition:persist client:visible />
      </div>
    </header>
    <Tree client:load treeItems={data} />
    <main class="ml-10 lg:ml-80 mr-10 lg:mr-80 mt-14 min-h-svh">
      <slot />
    </main>
    <footer
      class="flex items-center px-5 relative h-14 w-full bg-black border-[1px]"
    >
    </footer>
  </body>
</html>
